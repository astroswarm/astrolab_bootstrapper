---
- hosts: all
  tasks:
    - apt:
        update_cache: true
      become: true
- hosts: all
  tasks:
    - apt:
        name: ntp
      become: true

- hosts: all
  roles:
    - role: avinetworks.docker
      become: true
      docker_log_driver: syslog
      # This gets parsed by avinetworks.docker/templates/docker_config.j2, so we
      # need to render what will properly render our output, rather than render
      # our output directly.
      u_docker_log_opts:
        tag: "{% raw %}{{ '{{' }}.Name{{ '}}' }}/{{ '{{' }}.ImageID{{ '}}' }}{% endraw %}"
      docker_log_opts: "{{ u_docker_log_opts | to_yaml }}" # Convert unicode string to ascii strings

- hosts: all
  become: true
  tasks:
    - name: Create host-data directory
      file:
        path: /host-data
        owner: "{{ansible_user}}"
        group: "{{ansible_user}}"
        state: directory
        recurse: true
    - name: Install "ip route"
      apt:
        name: iproute2
  roles:
    - role: tumf.systemd-service
      systemd_service_name: expose_lan_ip_address
      systemd_service_Unit_Description: Write LAN IP address to a file that containers can read
      systemd_service_Service_ExecStart: /bin/sh -c "/sbin/ip route get 1 | /usr/bin/awk '{print $NF;exit}' | /usr/bin/xargs /bin/echo -n > /host-data/lan_ip_address"
      systemd_service_Service_Restart: always
      systemd_service_Service_RestartSec: 60

- hosts: all
  become: true
  tasks:
    - name: Download base image creator
      get_url:
        url: https://raw.githubusercontent.com/astroswarm/astrolab/master/import_base_image.sh
        dest: /tmp/import_base_image.sh
        mode: 0774
    - name: Build base image
      command: /tmp/import_base_image.sh

- hosts: all
  become: false
  roles:
    - role: dockerized_service_container
      service_name: swarm_brain
      git_repo: https://github.com/astroswarm/swarm_brain.git
      published_ports:
        - "8000:9292"
      volumes:
        - "/var/log/syslog:/mnt/host/var/log/syslog:ro"
        - "/host-data:/host-data:ro"
      env:
        ASTROSWARM_API_HOST: api.astroswarm.com
        HOST_DATA_DIR: /host-data
        RACK_ENV: development
    - role: dockerized_service_container
      service_name: heartbeat
      git_repo: https://github.com/astroswarm/heartbeat.git
      volumes:
        - "/host-data:/host-data:ro"
      env:
        BRAIN_WAN_PORT: 8000
        HOST_DATA_DIR: /host-data
        HEARTBEAT_INTERVAL_IN_SECONDS: 60

- hosts: all
  become: true
  tasks:
    - name: Create staging area for portainer state
      file:
        path: /mnt/stage/portainer/data
        group: "{{ansible_user}}"
        owner: "{{ansible_user}}"
        recurse: true
        state: directory
    - name: Install portainer image
      docker_image:
        name: portainer/portainer:1.13.3
        pull: true
      become: true
    - name: Run portainer container
      docker_container:
        entrypoint: "/portainer --host unix:///var/run/docker.sock --no-auth"
        name: portainer
        image: portainer/portainer:1.13.3
        published_ports:
          - "0.0.0.0:8001:9000"
        restart_policy: unless-stopped
        state: started
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "/mnt/stage/portainer/data:/data"
      become: true

