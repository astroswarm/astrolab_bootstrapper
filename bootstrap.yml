---
- hosts: all
  tasks:
    - apt:
        update_cache: true
      become: true
- hosts: all
  tasks:
    - apt:
        name: ntp
      become: true

- hosts: all
  tasks:
    - name: Prepare wpa_supplicant for wifi connectivity.
      copy:
        src: files/wpa_supplicant.conf
        dest: /etc/wpa_supplicant/wpa_supplicant.conf
        mode: 0600
        owner: root
        group: root

- hosts: all
  tasks:
    - name: Set the hostname
      copy:
        src: files/hostname
        dest: /etc/hostname
        mode: 0644
        owner: root
        group: root
    - name: Update /etc/hosts with the hostname
      copy:
        src: files/hosts
        dest: /etc/hosts
        mode: 0644
        owner: root
        group: root

- hosts: all
  tasks:
    - name: Install build prerequisites
      apt:
        name: "{{item}}"
      with_items:
        - build-essential
        - cmake
        - git
      become: true
    - name: Download QHYCCD SDK
      git:
        repo: https://github.com/astroswarm/QHYCCD_Linux.git
        dest: /tmp/QHYCCD_Linux
        version: origin/rg-qhy5-loader
    - name: Install QHYCCD SDK (includes udev rules)
      become: true
      shell: "cmake . && make install"
      args:
        chdir: /tmp/QHYCCD_Linux

- hosts: all
  tasks:
    - name: Install docker
      shell: curl -sSL https://get.docker.com/ | sh
      become: true
    - group:
        name: docker
        state: present
    - user: # Groups differ between x64 and Raspberry Pi (Arm)
        append: true
        name: "{{ansible_user}}"
        groups: docker,adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev
      become: true
      when: ansible_architecture == "x86_64"
    - user:
        append: true
        name: "{{ansible_user}}"
        groups: docker,pi,adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev,spi,i2c,gpio
      become: true
      when: ansible_architecture == "armv7l"

- hosts: all
  become: true
  roles:
    - role: tumf.systemd-service
      systemd_service_name: expose_lan_ip_address
      systemd_service_Unit_Description: Write LAN IP address to a file that containers can read
      systemd_service_Service_ExecStart: /bin/sh -c "/sbin/ip route get 1 | /usr/bin/awk '{print $NF;exit}' | /usr/bin/xargs /bin/echo -n > /host-data/lan_ip_address"
      systemd_service_Service_Restart: always
      systemd_service_Service_RestartSec: 60

- hosts: all
  become: true
  tasks:
    - apt:
        name: shellinabox
# Stop default shellinabox service
- hosts: all
  become: true
  tasks:
    - shell: systemctl disable shellinabox
# Run our custom shellinabox service
- hosts: all
  become: true
  roles:
    - role: tumf.systemd-service
      systemd_service_name: web_shell
      systemd_service_Unit_Description: Provide a web-based shell interface to the box
      systemd_service_Service_ExecStart: /usr/bin/shellinaboxd -v -t -p 4200
      systemd_service_Service_Restart: on-failure

- hosts: all
  become: true
  tasks:
    - name: Create shared area for host-data
      file:
        path: /host-data
        owner: "{{ansible_user}}"
        group: "{{ansible_user}}"
        recurse: true
        state: directory
    - name: Create shared area for portainer state
      file:
        path: /mnt/shared/portainer/data
        group: "{{ansible_user}}"
        owner: "{{ansible_user}}"
        recurse: true
        state: directory
    - name: Install "ip route"
      apt:
        name: iproute2
      become: true
    - name: Install easy_install
      apt:
        name: python-setuptools
      become: true
    - name: Install pip
      become: true
      shell: "easy_install pip"
    - name: Install docker-compose
      pip:
        name: docker-compose

- hosts: all
  become: true
  tasks:
    - name: Download Astrolab
      git:
        repo: https://github.com/astroswarm/astrolab.git
        dest: /usr/local/astrolab
    - name: Build and run Astrolab
      shell: . ./production.sh && /usr/local/bin/docker-compose pull && /usr/local/bin/docker-compose up -d --build
      args:
        chdir: /usr/local/astrolab
        