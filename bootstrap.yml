---
- hosts: all
  tasks:
    - apt:
        update_cache: true
      become: true
- hosts: all
  tasks:
    - apt:
        name: ntp
      become: true

- hosts: all
  tasks:
    - name: Install build prerequisites
      apt:
        name: "{{item}}"
      with_items:
        - build-essential
        - cmake
        - git
    - name: Download QHYCCD SDK
      git:
        repo: https://github.com/astroswarm/QHYCCD_Linux.git
        dest: /tmp/QHYCCD_Linux
        version: origin/rg-qhy5-loader
    - name: Install QHYCCD SDK (includes udev rules)
      become: true
      shell: "cmake . && make install"
      args:
        chdir: /tmp/QHYCCD_Linux

- hosts: all
  roles:
    - role: avinetworks.docker
      become: true
  tasks:
    - group:
        name: docker
        state: present
    - user:
        append: true
        name: "{{ansible_user}}"
        groups: docker,pi,adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev,spi,i2c,gpio

- hosts: all
  become: true
  tasks:
    - name: Create shared area for host-data
      file:
        path: /host-data
        owner: "{{ansible_user}}"
        group: "{{ansible_user}}"
        recurse: true
        state: directory
    - name: Create shared area for portainer state
      file:
        path: /mnt/shared/portainer/data
        group: "{{ansible_user}}"
        owner: "{{ansible_user}}"
        recurse: true
        state: directory
    - name: Install "ip route"
      apt:
        name: iproute2
    - name: Install pip
      apt:
        name: python-pip
    - name: Install docker-compose
      pip:
        name: docker-compose
  roles:
    - role: tumf.systemd-service
      systemd_service_name: expose_lan_ip_address
      systemd_service_Unit_Description: Write LAN IP address to a file that containers can read
      systemd_service_Service_ExecStart: /bin/sh -c "/sbin/ip route get 1 | /usr/bin/awk '{print $NF;exit}' | /usr/bin/xargs /bin/echo -n > /host-data/lan_ip_address"
      systemd_service_Service_Restart: always
      systemd_service_Service_RestartSec: 60

- hosts: all
  become: true
  tasks:
    - name: Download Astrolab
      git:
        repo: https://github.com/astroswarm/astrolab.git
        dest: /usr/local/astrolab
    - name: Build and run Astrolab
      shell: . ./production.sh && /usr/local/bin/docker-compose up -d --build
      args:
        chdir: /usr/local/astrolab
        